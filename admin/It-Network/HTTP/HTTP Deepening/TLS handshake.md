# http | TLS handshake



# TLS란

- TLS는 인터넷 상의 커뮤니케이션을 위한 개인정보와 데이터 보안을 용이하게 하기 위해 설계된 보안 프로토콜
- 주요 사례는 웹사이트를 로드하는 웹 브라우저와 같이 웹 응용 프로그램과 서버간의 커뮤니케이션을 암호화하는 것
- TLS는 Transport Layer Security로 TCP handshake(3-way handshake)가 일어나고 난 뒤, TLS handshake를 통해 연결됨
- TLS는 SSL(Secure Socket Layer)이라 불리는 이전의 암호화 프로토콜에서 발전한 것

## TLS가 하는 것

- TLS는 암호화, 인증, 무결성이라는 세가지 주요 요소를 달성
    - 암호화: 제 3자로부터 전송되는 데이터를 숨김
    - 인증: 정보를 교환하는 당사자가 요청된 당사자임을 보장
    - 무결성: 데이터가 위조되거나 변조되지 않았는지 확인

## TLS 작동방식

1. 웹 사이트나 응용 프로그램이 TLS를 사용하려면, 원본 서버에 TLS 인증서가 설치되어 있어야 함
2. 인증기관이 도메인을 소유한 사람 혹은 비즈니스에 TLS 인증서를 발행
3. 인증서는 서버의 공개 키와 더블어 누가 도메인 소유자인지에 대해 중요한 정보를 포함함
    1. 이 두가지는 모두 서버의 신원을 확인하는데 중요
4. TLS는 TLS handshake로 알려진 일련의 순서를 통해 초기화됨
    1. 사용할 TLS 버젼을 지정
    2. 사용할 암호 제품군을 결정
    3. 서버의 TLS 인증서를 사용해 서버의 신원을 인증
    4. handshake가 완료된 후 키간의 메시지를 암호화하기 위한 세션 키를 생성

## TLS handshake가 이루어지는 단계

- TLS handshake의 정확한 단계는 사용되는 키 교환 알고리즘의 유형과 커뮤니케이션 양측에서 모두 지원하는 암호 제품군의 유형에 따라 달라진다
- 대부분 RSA 키 교환 알고리즘 사용

---

1. Client Hello
    1. 클라이언트가 서버로 HELLO 메세지를 전송하면서 handshake를 개시
    2. 이 메시지에는 클라이언트가 지원하는 TLS 버젼 지원되는 암호 제품군, 그리고 클라이언트 무작위라고 하는 무작위 바이트 문자열이 포함
2. Server Hello
    1. Client Hello 메세지에 대한 응답으로 서버가 서버의 TLS(SSL), 서버에서 선택한 암호 제품군, 그리고 서버에서 생성한 또 다른 문자열인 서버 무작위를 포함하는 메시지를 전송
3. 인증
    1. 클라이언트가 서버의 SSL 인증서를 인증서 발행 기관을 통해 검증함
    2. 이를 통해 서버가 인증서에 명시된 서버가 맞는지 확인
4. 예비 마스터 암호
    1. 클라이언트가 예비 마스터 암호라고 하는 무작위 바이트 문자열을 하나 더 전송
    2. 예비 마스터 암호는 공개키로 암호화 되어 있으며, 서버가 개인키로만 해독할 수 있음
5. 개인 키 사용
    1. 서버가 예비 마스터 암호를 해독
6. 세션 키 생성
    1. 클라이언트와 서버 모두 클라이언트 무작위, 서버 무작위, 예비 마스터 암호를 이용해 세션키를 생성
    2. 모두 같은 결과가 나와야함
7. 클라이언트 준비 완료
    1. 클라이언트가 세션키로 암호화된 `완료` 메시지를 전송
8.  서버 준비 완료
    1. 세션 키로 암호화된 `완료` 메세지를 전송
9. 안전한 대칭 암호화 성공
    1. handshake가 완료되고, 세션키를 이용해 통신이 계속 진행

---

모든 TLS handshake는 비대칭 암호화(공개, 개인키)를 사용하지만, 세션키를 생성하는 과정에서 무두가 개인키를 사용하는 것은 아님